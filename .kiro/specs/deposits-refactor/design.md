# מסמך עיצוב - ניהול מפקידים והפקדות

## סקירה כללית

הפיצ'ר החדש יפריד בין מפקידים (אנשים) להפקדות (פעולות כספיות), ויאפשר למפקיד אחד להיות בעל מספר הפקדות נפרדות. השינוי כולל עדכון מבנה הנתונים, המרת נתונים קיימים, ועדכון ממשק המשתמש.

## ארכיטקטורה

### מבנה נתונים חדש

המערכת תעבור ממבנה שטוח (הפקדה = מפקיד) למבנה היררכי (מפקיד -> הפקדות רבות).

```
מפקיד (Depositor)
  ├── פרטים אישיים (שם, ת.ז., טלפון)
  ├── פרטי בנק (אופציונלי - למס"ב)
  └── הפקדות (Deposits[])
       ├── הפקדה 1
       │    ├── סכום, תאריך, תקופה
       │    └── משיכות (Withdrawals[])
       ├── הפקדה 2
       └── הפקדה 3
```

### שכבות המערכת

1. **שכבת נתונים (Database Layer)** - `src/database/database.ts`
   - ממשקים חדשים: `Depositor`, `Deposit` (מעודכן)
   - פונקציות CRUD למפקידים
   - פונקציות CRUD להפקדות (מעודכנות)
   - לוגיקת המרת נתונים

2. **שכבת ממשק משתמש (UI Layer)** - `src/pages/DepositsPage.tsx`
   - תצוגת רשימת מפקידים
   - תצוגת הפקדות למפקיד
   - טפסים ליצירה ועריכה
   - כרטיסי מפקיד

3. **שכבת אחסון (Storage Layer)** - `localStorage`
   - טבלה חדשה: `gemach_depositors`
   - טבלה מעודכנת: `gemach_deposits` (עם `depositorId`)
   - טבלה קיימת: `gemach_withdrawals` (ללא שינוי)

## רכיבים וממשקים

### 1. ממשקי נתונים (Interfaces)

#### Depositor (חדש)
```typescript
interface Depositor {
  id: number                    // מזהה ייחודי
  name: string                  // שם מלא
  idNumber: string              // מספר זהות (חובה/אופציונלי לפי הגדרות)
  phone: string                 // טלפון
  notes?: string                // הערות
  
  // פרטי בנק (אופציונלי - למס"ב עתידי)
  bankCode?: string             // קוד בנק (2 ספרות)
  branchNumber?: string         // מספר סניף (3 ספרות)
  accountNumber?: string        // מספר חשבון (עד 9 ספרות)
}
```

#### Deposit (מעודכן)
```typescript
interface Deposit {
  id: number                    // מזהה ייחודי
  depositorId: number           // קישור למפקיד (חדש!)
  amount: number                // סכום ההפקדה
  depositDate: string           // תאריך הפקדה
  depositPeriod: number         // תקופה בחודשים
  reminderDays?: number         // ימי תזכורת
  status: 'active' | 'withdrawn' // סטטוס
  
  // אמצעי תשלום להפקדה
  depositPaymentMethod?: 'cash' | 'transfer' | 'check' | 'credit' | 'other'
  depositPaymentDetails?: string // JSON string
  
  notes?: string                // הערות
  
  // שדות ישנים לתאימות לאחור
  withdrawnAmount?: number      // סכום שנמשך (מחושב מטבלת withdrawals)
  withdrawnDate?: string        // תאריך משיכה אחרונה
  withdrawalPaymentMethod?: string
  withdrawalPaymentDetails?: string
}
```

#### Withdrawal (קיים - ללא שינוי)
```typescript
interface Withdrawal {
  id: number
  depositId: number             // קישור להפקדה
  amount: number
  date: string
  paymentMethod?: 'cash' | 'transfer' | 'check' | 'credit' | 'other'
  paymentDetails?: string
  paymentDetailsComplete?: boolean
  notes?: string
}
```

### 2. פונקציות מסד נתונים

#### פונקציות מפקידים (חדשות)

```typescript
// הוספת מפקיד חדש
addDepositor(depositor: Omit<Depositor, 'id'>): Depositor | { error: string }
  - בדיקת תקינות מספר זהות (אם חובה)
  - בדיקת כפילות מספר זהות
  - יצירת מפקיד חדש
  - החזרת המפקיד או שגיאה

// קבלת כל המפקידים
getDepositors(): Depositor[]
  - החזרת רשימת כל המפקידים

// קבלת מפקיד לפי ID
getDepositorById(id: number): Depositor | null
  - חיפוש מפקיד לפי מזהה

// עדכון מפקיד
updateDepositor(id: number, updates: Partial<Depositor>): { success: boolean; error?: string }
  - בדיקת תקינות נתונים
  - עדכון פרטי מפקיד
  - החזרת הצלחה או שגיאה

// מחיקת מפקיד
deleteDepositor(id: number): { success: boolean; error?: string }
  - בדיקה שאין הפקדות פעילות
  - מחיקת מפקיד והיסטוריה
  - החזרת הצלחה או שגיאה

// קבלת יתרה כוללת של מפקיד
getDepositorBalance(depositorId: number): number
  - חישוב סכום כל ההפקדות הפעילות
  - הפחתת כל המשיכות
  - החזרת יתרה נוכחית

// קבלת הפקדות של מפקיד
getDepositorDeposits(depositorId: number): Deposit[]
  - החזרת כל ההפקדות של מפקיד
  - מיון לפי תאריך
```

#### פונקציות הפקדות (מעודכנות)

```typescript
// הוספת הפקדה למפקיד קיים
addDepositToDepositor(depositorId: number, deposit: Omit<Deposit, 'id' | 'depositorId' | 'status'>): Deposit | { error: string }
  - בדיקת קיום מפקיד
  - יצירת הפקדה חדשה
  - קישור למפקיד
  - החזרת הפקדה או שגיאה

// עדכון הפקדה (קיימת - ללא שינוי משמעותי)
updateDeposit(id: number, updates: Partial<Deposit>): void

// מחיקת הפקדה (קיימת - ללא שינוי)
deleteDeposit(id: number): void

// משיכה מהפקדה (קיימת - ללא שינוי)
withdrawDeposit(id: number, amount: number, method?: string, details?: string): boolean
```

### 3. לוגיקת המרת נתונים

#### תהליך המרה (Migration)

```typescript
migrateDepositsToDepositors(): void
```

**שלבי ההמרה:**

1. **זיהוי נתונים ישנים**
   - בדיקה אם קיימת טבלת `depositors`
   - אם לא - זיהוי שצריך להמיר

2. **יצירת מפקידים מהפקדות קיימות**
   ```
   עבור כל הפקדה ישנה:
     - צור מפקיד חדש עם:
       * name = deposit.depositorName
       * idNumber = deposit.idNumber
       * phone = deposit.phone
       * notes = deposit.notes (אם יש)
     - שמור את ה-ID החדש של המפקיד
   ```

3. **עדכון הפקדות עם קישור למפקיד**
   ```
   עבור כל הפקדה:
     - הוסף שדה depositorId
     - קשר למפקיד המתאים
     - שמור שדות ישנים לתאימות לאחור
   ```

4. **שמירת דגל המרה**
   ```
   - שמור ב-localStorage: 'gemach_deposits_migrated' = 'true'
   - מנע המרה כפולה
   ```

5. **הצגת הודעה למשתמש**
   ```
   - הודעה: "המערכת עודכנה! מפקידים והפקדות הומרו בהצלחה"
   - מספר מפקידים שנוצרו
   - מספר הפקדות שעודכנו
   ```

#### טיפול בכפילויות

במהלך ההמרה, אם מזוהים מפקידים כפולים (אותו מספר זהות או שם):
- **אם יש מספר זהות**: מיזוג אוטומטי - כל ההפקדות יקושרו לאותו מפקיד
- **אם אין מספר זהות**: יצירת מפקידים נפרדים + הודעת אזהרה למשתמש

### 4. ממשק משתמש

#### תצוגה ראשית - רשימת מפקידים

```
┌─────────────────────────────────────────────────────┐
│  🏦 הפקדות                                          │
│  [➕ מפקיד חדש]                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ 👤 ישראל ישראלי                              │  │
│  │ 📞 050-1234567                                │  │
│  │ 💰 יתרה: ₪5,000                               │  │
│  │ 📊 3 הפקדות פעילות                           │  │
│  │ [👁️ צפה] [✏️ ערוך] [🗑️ מחק]                  │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ 👤 שרה כהן                                   │  │
│  │ 📞 052-9876543                                │  │
│  │ 💰 יתרה: ₪12,000                              │  │
│  │ 📊 2 הפקדות פעילות                           │  │
│  │ [👁️ צפה] [✏️ ערוך] [🗑️ מחק]                  │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### תצוגת מפקיד - הפקדות

```
┌─────────────────────────────────────────────────────┐
│  ← חזרה לרשימת מפקידים                              │
│                                                     │
│  👤 ישראל ישראלי                                    │
│  📞 050-1234567                                      │
│  🆔 123-45-6789                                      │
│  💰 יתרה כוללת: ₪5,000                              │
│                                                     │
│  [➕ הפקדה חדשה] [✏️ ערוך פרטים]                   │
├─────────────────────────────────────────────────────┤
│  📋 הפקדות:                                         │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ 📅 01/01/2024                                 │  │
│  │ 💵 סכום: ₪3,000                               │  │
│  │ 📊 יתרה: ₪3,000 (פעילה)                      │  │
│  │ ⏱️ תקופה: 12 חודשים                           │  │
│  │ [💸 משיכה] [📄 שטר] [✏️ ערוך]                 │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ 📅 15/03/2024                                 │  │
│  │ 💵 סכום: ₪2,000                               │  │
│  │ 📊 יתרה: ₪2,000 (פעילה)                      │  │
│  │ ⏱️ תקופה: 6 חודשים                            │  │
│  │ [💸 משיכה] [📄 שטר] [✏️ ערוך]                 │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ 📅 20/05/2024                                 │  │
│  │ 💵 סכום: ₪1,000                               │  │
│  │ 📊 יתרה: ₪0 (נמשכה)                          │  │
│  │ ⏱️ תקופה: 3 חודשים                            │  │
│  │ [📄 שטר] [✏️ ערוך]                            │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### טופס מפקיד חדש

```
┌─────────────────────────────────────────────────────┐
│  ➕ מפקיד חדש                                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  שם מלא: [________________]                         │
│  מספר זהות: [___-__-____]                          │
│  טלפון: [___-_______]                              │
│  הערות: [________________]                         │
│                                                     │
│  📋 הפקדה ראשונה:                                   │
│  סכום: [________] ₪                                │
│  תאריך: [__/__/____]                               │
│  תקופה: [__] חודשים                                │
│  ימי תזכורת: [__] ימים                             │
│  אמצעי תשלום: [▼ בחר]                              │
│                                                     │
│  🏦 פרטי בנק (אופציונלי):                          │
│  קוד בנק: [__]                                     │
│  מספר סניף: [___]                                  │
│  מספר חשבון: [_________]                           │
│                                                     │
│  [💾 שמור] [❌ ביטול]                               │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### טופס הפקדה חדשה (למפקיד קיים)

```
┌─────────────────────────────────────────────────────┐
│  ➕ הפקדה חדשה - ישראל ישראלי                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  סכום: [________] ₪                                │
│  תאריך הפקדה: [__/__/____]                         │
│  תקופה: [__] חודשים                                │
│  ימי תזכורת: [__] ימים                             │
│                                                     │
│  אמצעי תשלום: [▼ בחר]                              │
│  [פרטי תשלום נוספים...]                            │
│                                                     │
│  הערות: [________________]                         │
│                                                     │
│  [💾 שמור] [❌ ביטול]                               │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## מודלים של נתונים

### מבנה אחסון ב-localStorage

```javascript
// טבלה חדשה
gemach_depositors: [
  {
    id: 1,
    name: "ישראל ישראלי",
    idNumber: "123456789",
    phone: "0501234567",
    notes: "",
    bankCode: "12",
    branchNumber: "345",
    accountNumber: "123456789"
  }
]

// טבלה מעודכנת
gemach_deposits: [
  {
    id: 1,
    depositorId: 1,  // חדש!
    amount: 3000,
    depositDate: "2024-01-01",
    depositPeriod: 12,
    reminderDays: 30,
    status: "active",
    depositPaymentMethod: "cash",
    depositPaymentDetails: "",
    notes: "",
    // שדות ישנים לתאימות לאחור
    depositorName: "ישראל ישראלי",
    idNumber: "123456789",
    phone: "0501234567",
    withdrawnAmount: 0,
    withdrawnDate: ""
  }
]

// טבלה קיימת (ללא שינוי)
gemach_withdrawals: [
  {
    id: 1,
    depositId: 1,
    amount: 500,
    date: "2024-06-01",
    paymentMethod: "cash",
    paymentDetails: "",
    notes: ""
  }
]
```

## טיפול בשגיאות

### שגיאות אפשריות ופתרונות

1. **מספר זהות לא תקין**
   - בדיקת ספרת ביקורת
   - הודעה: "מספר זהות לא תקין"

2. **מספר זהות כפול**
   - בדיקה במסד נתונים
   - הודעה: "מפקיד עם מספר זהות זה כבר קיים: [שם]"

3. **מחיקת מפקיד עם הפקדות פעילות**
   - בדיקת יתרה
   - הודעה: "לא ניתן למחוק מפקיד עם הפקדות פעילות"

4. **משיכה גדולה מהיתרה**
   - בדיקת יתרה זמינה
   - הודעה: "הסכום גדול מהיתרה הזמינה (₪X)"

5. **שגיאת המרה**
   - לוג מפורט
   - גיבוי אוטומטי לפני המרה
   - אפשרות שחזור

## אסטרטגיית בדיקות

### בדיקות יחידה (Unit Tests)

1. **פונקציות מפקידים**
   - `addDepositor()` - יצירה תקינה, שגיאות
   - `updateDepositor()` - עדכון, ולידציה
   - `deleteDepositor()` - מחיקה, מניעת מחיקה
   - `getDepositorBalance()` - חישוב יתרה

2. **פונקציות הפקדות**
   - `addDepositToDepositor()` - הוספה למפקיד קיים
   - `getDepositorDeposits()` - קבלת הפקדות

3. **פונקציות המרה**
   - `migrateDepositsToDepositors()` - המרה תקינה
   - טיפול בכפילויות
   - שמירת נתונים ישנים

### בדיקות אינטגרציה

1. **זרימת יצירת מפקיד**
   - יצירה -> שמירה -> קריאה -> אימות

2. **זרימת הוספת הפקדה**
   - בחירת מפקיד -> הוספת הפקדה -> עדכון יתרה

3. **זרימת משיכה**
   - בחירת הפקדה -> משיכה -> עדכון יתרה -> עדכון סטטוס

4. **זרימת המרה**
   - נתונים ישנים -> המרה -> אימות נתונים חדשים

### בדיקות ממשק משתמש

1. **ניווט**
   - רשימת מפקידים -> תצוגת מפקיד -> חזרה

2. **טפסים**
   - מילוי שדות -> ולידציה -> שמירה -> הצגה

3. **פעולות**
   - יצירה, עריכה, מחיקה, משיכה

## תאימות לאחור

### שמירת נתונים ישנים

כל הפקדה תשמור את השדות הישנים:
- `depositorName` - שם המפקיד
- `idNumber` - מספר זהות
- `phone` - טלפון
- `withdrawnAmount` - סכום שנמשך
- `withdrawnDate` - תאריך משיכה

זה מאפשר:
1. גישה לנתונים ישנים אם נדרש
2. תמיכה בקוד ישן שעדיין משתמש בשדות אלה
3. אפשרות שחזור במקרה של בעיה

### תמיכה בגרסאות קודמות

המערכת תזהה אוטומטית אם הנתונים במבנה הישן ותבצע המרה בטעינה הראשונה.

## הערות נוספות

### ביצועים

- שימוש ב-`localStorage` - מהיר למספר סביר של מפקידים (עד 1000)
- אינדקס על `depositorId` בהפקדות - חיפוש מהיר
- קאשינג של חישובי יתרה - מניעת חישובים מיותרים

### אבטחה

- ולידציה של כל קלט משתמש
- ניקוי מספרי זהות (הסרת רווחים ומקפים)
- מניעת SQL injection (לא רלוונטי - localStorage)

### נגישות

- תמיכה בקורא מסך
- ניווט במקלדת
- ניגודיות צבעים
- טקסטים ברורים

### הרחבות עתידיות

1. **אינטגרציה עם מס"ב**
   - שימוש בפרטי בנק של מפקידים
   - יצירת קבצי החזרה אוטומטיים

2. **דוחות מתקדמים**
   - דוח מפקידים לפי תקופה
   - דוח הפקדות שמתקרבות לפקיעה
   - גרפים וסטטיסטיקות

3. **תזכורות אוטומטיות**
   - SMS/Email למפקידים
   - תזכורות לפני תום תקופה

4. **ייצוא ויבוא**
   - Excel
   - PDF
   - CSV
