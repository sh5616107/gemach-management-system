# תיקון באגים - מערכת העברת הלוואות לערבים

## באגים שתוקנו ✅

### 1. הלוואות מועברות מופיעות בהתראות ✅
**בעיה:** הלוואות שהועברו לערבים עדיין מופיעות בדף הבית ובטבלת הלוואות באיחור.
**תיקון:** הוספנו סינון ב-`getOverdueLoans()` שמסנן הלוואות עם `transferredToGuarantors === true`.
**קובץ:** `src/database/database.ts`

### 7. כפתור חזרה לא עובד ✅
**בעיה:** כפתור החזרה בדף הלוואות שפג תוקפן מנווט ל-`/admin-tools` במקום לדף הבית.
**תיקון:** שינינו את הניווט מ-`/admin-tools` ל-`/`.
**קובץ:** `src/pages/OverdueLoansPage.tsx`

### 8. לא מוצג שם הערב בכרטיס חוב ✅
**בעיה:** בכרטיס חוב ערב לא מוצג שם הערב, רק "חוב ערב פעיל".
**תיקון:** הוספנו טעינה של פרטי הערב והצגת שמו בכותרת הכרטיס.
**קובץ:** `src/components/GuarantorDebtCard.tsx`

### 9. מחיקת תשלום ערב לא מעדכנת סטטוס ✅
**בעיה:** כשמוחקים תשלום של ערב, הסטטוס נשאר "שולם" במקום לחזור ל-"פעיל".
**תיקון:** הוספנו לוגיקה ב-`deletePayment()` שבודקת אם התשלום היה לחוב ערב ומעדכנת את הסטטוס בהתאם ליתרה ותאריכי פירעון.
**קובץ:** `src/database/database.ts`

---

### 5. דילוג על שלבים כשיש ערב אחד ✅
**בעיה:** כשיש רק ערב אחד, עדיין מציגים שלבים מיותרים (בחירת ערבים, חלוקת סכומים).
**תיקון:** הוספנו בדיקה ב-useEffect שאם יש רק ערב אחד, מדלגים ישר לשלב תנאי התשלום ומגדירים אוטומטית את הערב והסכום.
**קובץ:** `src/components/LoanTransferModal.tsx`

### 6. ולידציה של תאריכי תשלומים ✅
**בעיה:** אפשר להגדיר תשלומים באותו תאריך או בסדר הפוך.
**תיקון:** הוספנו ולידציה מלאה:
- בדיקה שאין תאריכים זהים
- בדיקה שכל תאריך מאוחר מהקודם
- בדיקה שכל תאריך מוקדם מהבא
- הגבלת min בשדה התאריך לפי התאריך הקודם
**קובץ:** `src/components/LoanTransferModal.tsx`

### 11. טבלת פרעונות נפרדת לערבים ✅
**בעיה:** פרעונות של ערבים מעורבבים עם פרעונות של לווים, לא ברור מי שילם.
**תיקון:** 
- הוספנו שדות `paidBy`, `guarantorId`, `guarantorName` ל-`DatabasePayment`
- הוספנו עמודה "שולם על ידי" בטבלת הפרעונות
- עדכנו את השובר להציג את שם הערב ופרטיו
- עדכנו את רישום הפרעון לשמור את פרטי הערב
**קבצים:** `src/database/database.ts`, `src/pages/LoansPage.tsx`

### 10. לוגיקה של פרעון לווה אחרי העברה לערבים ✅
**בעיה:** אם הלווה פורע אחרי שההלוואה הועברה לערבים, לא ברור מה קורה לחובות הערבים.
**תיקון:** 
- יצרנו פונקציה `handleBorrowerPaymentAfterTransfer()` שמטפלת בכל התרחישים:
  - **פרעון מלא:** מוחקת אוטומטית את כל חובות הערבים ומעדכנת סטטוס ל-"paid"
  - **פרעון חלקי - חלוקה שווה:** מפחיתה שווה בשווה מכל הערבים
  - **פרעון חלקי - חלוקה לא שווה:** מפחיתה באופן יחסי לפי חלק כל ערב בחוב
- הוספנו בדיקה ברישום פרעון שבודקת אם ההלוואה הועברה לערבים
- כל הפרעונות מסומנים כ-`paidBy: 'borrower'` להבחנה
**קבצים:** `src/database/database.ts`, `src/pages/LoansPage.tsx`

### 4. היסטוריית העברות ✅
**בעיה:** אין גישה להיסטוריית העברות ואין אפשרות לצפות בהעברות קודמות.
**תיקון:**
- הוספנו כפתור "📜 היסטוריית העברות" בדף הלוואות שפג תוקפן
- יצרנו מודל מפורט שמציג את כל ההלוואות שהועברו לערבים
- הצגת פרטים מלאים: לווה, תאריך העברה, ערבים, סכומים, סטטוס כל ערב
- הצגת יתרות עדכניות לכל חוב ערב
- הצגת הערות על ההעברה
**קובץ:** `src/pages/OverdueLoansPage.tsx`

**הערה:** אפשרות עריכה/ביטול העברה לא מיושמת כרגע - דורשת החלטה על הלוגיקה העסקית (מה קורה עם תשלומים שכבר בוצעו).

---

### 2. חישוב תשלומים שגוי בסיכום ✅
**בעיה:** כשמחלקים הלוואה בין 2 ערבים ובוחרים 2 תשלומים, המערכת מציגה "2 תשלומים של ₪1250" במקום "2 תשלומים של ₪625 לכל ערב".
**תיקון:** עדכנו את שלב האישור הסופי להציג את החישוב הנכון לכל ערב בנפרד:
- הצגת מספר התשלומים וסכום כל תשלום לכל ערב
- חישוב נכון: סכום הערב ÷ מספר תשלומים
- הצגה ברורה: "ערב X: 2 תשלומים × ₪625 = ₪1250"
**קובץ:** `src/components/LoanTransferModal.tsx`

---

### 3. תנאי תשלום שונים לכל ערב ✅
**בעיה:** אין אפשרות לבחור תנאי תשלום שונים לכל ערב (אחד תשלום אחד, השני תשלומים).

**תיקון:** שינוי מלא בממשק ובלוגיקה:
1. **ממשק משתמש חדש:** שלב תנאי התשלום מציג כעת טופס נפרד לכל ערב
   - כל ערב יכול לבחור בין תשלום אחד או תשלומים
   - כל ערב יכול להגדיר מספר תשלומים שונה
   - כל ערב יכול להגדיר תאריכי פירעון שונים
2. **מבנה נתונים:** הוספנו `guarantorPaymentTerms` - Map שמחזיק תנאי תשלום לכל ערב
3. **פונקציה חדשה:** `transferLoanToGuarantorsWithIndividualTerms()` שמקבלת תנאי תשלום לכל ערב
4. **סיכום מעודכן:** הסיכום מציג את תנאי התשלום של כל ערב בנפרד

**דוגמה:**
- ערב 1: תשלום אחד של ₪1250 בתאריך 15/01/2025
- ערב 2: 3 תשלומים של ₪416.67 בתאריכים 01/02, 01/03, 01/04

**קבצים:** `src/components/LoanTransferModal.tsx`, `src/database/database.ts`

---

## סיכום סופי

### 4. היסטוריית העברות ואפשרות עריכה
**בעיה:** אין גישה להיסטוריית העברות ואין אפשרות לערוך העברה.

**פתרון מוצע:**
1. הוספת כפתור "היסטוריית העברות" בדף הלוואות שפג תוקפן.
2. יצירת מודל שמציג את כל ההלוואות שהועברו עם פרטים מלאים.
3. הוספת אפשרות "ביטול העברה" או "עריכת העברה".

**שאלות לשקול:**
- מה קורה כשמבטלים העברה? האם מוחקים את חובות הערבים?
- מה קורה אם הערב כבר שילם חלק?
- האם לאפשר עריכה חלקית (שינוי סכומים, תאריכים)?

### 5. דילוג על שלבים כשיש ערב אחד
**בעיה:** כשיש רק ערב אחד, עדיין מציגים שלבים מיותרים (בחירת ערבים, חלוקת סכומים).

**פתרון מוצע:**
1. בדיקה בתחילת המודל - אם יש רק ערב אחד, לדלג ישר לשלב תנאי התשלום.
2. הגדרה אוטומטית של הערב היחיד וכל הסכום.

**קובץ לעדכון:** `src/components/LoanTransferModal.tsx`

### 6. ולידציה של תאריכי תשלומים
**בעיה:** אפשר להגדיר תשלומים באותו תאריך או בסדר הפוך.

**פתרון מוצע:**
1. הוספת ולידציה שבודקת שכל תאריך מאוחר מהקודם.
2. הוספת ולידציה שבודקת שאין תאריכים זהים.
3. הצגת הודעת שגיאה ברורה.

**קובץ לעדכון:** `src/components/LoanTransferModal.tsx`

### 10. לוגיקה של פרעון לווה אחרי העברה לערבים
**בעיה:** אם הלווה פורע אחרי שההלוואה הועברה לערבים, לא ברור מה קורה לחובות הערבים.

**פתרון מוצע:**
1. **פרעון מלא:** מחיקה אוטומטית של כל חובות הערבים + עדכון סטטוס ל-"paid".
2. **פרעון חלקי - חלוקה שווה:** הפחתה יחסית מכל הערבים.
3. **פרעון חלקי - חלוקה לא שווה:** מודל שמאפשר למנהל להחליט איך לחלק את הפרעון.

**שאלות לשקול:**
- האם לאפשר ללווה לפרוע אחרי העברה?
- האם לחסום פרעונות של הלווה ולאפשר רק לערבים?
- מה קורה עם תשלומים שהערבים כבר שילמו?

**קבצים לעדכון:**
- `src/pages/LoansPage.tsx` - הוספת לוגיקה בעת רישום פרעון
- `src/database/database.ts` - פונקציה חדשה `handleBorrowerPaymentAfterTransfer()`

### 11. טבלת פרעונות נפרדת לערבים
**בעיה:** פרעונות של ערבים מעורבבים עם פרעונות של לווים, לא ברור מי שילם.

**פתרון מוצע:**
1. הוספת שדה `paidBy` ל-`DatabasePayment` (borrower/guarantor).
2. הוספת שדה `guarantorName` להצגה בטבלה.
3. יצירת טבלה נפרדת או סינון בטבלה הקיימת.
4. עדכון השובר להציג את שם הערב.

**קבצים לעדכון:**
- `src/database/database.ts` - עדכון interface `DatabasePayment`
- `src/pages/LoansPage.tsx` - הצגה נפרדת של פרעונות ערבים
- קומפוננטת השובר - הוספת שם ערב

---

**תוקנו:** 11 מתוך 11 באגים! 🎉✅

כל הבאגים תוקנו בהצלחה:
1. ✅ הלוואות מועברות לא מופיעות בהתראות
2. ✅ חישוב תשלומים נכון בסיכום
3. ✅ תנאי תשלום שונים לכל ערב
4. ✅ היסטוריית העברות מלאה
5. ✅ דילוג על שלבים כשיש ערב אחד
6. ✅ ולידציה מלאה של תאריכים
7. ✅ כפתור חזרה תקין
8. ✅ הצגת שם ערב בכרטיס
9. ✅ עדכון סטטוס בעת מחיקת תשלום
10. ✅ לוגיקה מלאה לפרעון לווה אחרי העברה
11. ✅ טבלת פרעונות עם הבחנה בין לווה לערב

**המערכת כעת מלאה ופונקציונלית!**
- תמיכה מלאה בתנאי תשלום שונים לכל ערב
- ולידציה מקיפה בכל השלבים
- היסטוריה ומעקב מלא
- טיפול נכון בכל התרחישים
