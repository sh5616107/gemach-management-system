# דרישות מערכת יצירת קבצי מס"ב

## מבוא

מערכת יצירת קבצי מס"ב מאפשרת למנהל הגמ"ח ליצור קבצים בפורמט מס"ב (מערכות סליקה בנקאיות) לצורך גביית תשלומים מלווים באמצעות הרשאה לחיוב חשבון. המערכת תייצר קובץ טקסט בפורמט Fixed Width המדויק של מס"ב, מוכן להעלאה למערכת מס"ב לביצוע הגבייה.

## מילון מונחים

- **MASAV_System**: מערכת יצירת קבצי מס"ב
- **Institution_Code**: קוד מוסד/נושא - מספר ייחודי של 8 ספרות שניתן ע"י מס"ב
- **Sender_Code**: מספר מוסד שולח - מספר של 5 ספרות שניתן ע"י מס"ב
- **Bank_Account**: חשבון בנק - כולל קוד בנק, מספר סניף, מספר חשבון
- **Reference_Number**: מספר אסמכתא - מזהה ייחודי לכל חיוב (6 ספרות ימניות)
- **Charge_File**: קובץ חיובים - קובץ טקסט בפורמט מס"ב
- **Header_Record**: רשומת כותרת - הרשומה הראשונה בקובץ
- **Transaction_Record**: רשומת תנועה - רשומת חיוב בודדת
- **Summary_Record**: רשומת סיכום - רשומת בקרה בסוף הקובץ
- **Charge_Date**: תאריך חיוב - התאריך בו יבוצע החיוב בפועל
- **Borrower_Bank_Details**: פרטי בנק של לווה

## דרישות

### דרישה 1: הגדרות מוסד למס"ב

**User Story:** כמנהל גמ"ח, אני רוצה להגדיר את פרטי המוסד למס"ב פעם אחת, כדי שהם ישמרו ויופיעו בכל קובץ שאייצר.

#### קריטריוני קבלה

1. THE MASAV_System SHALL לאפשר הזנת קוד מוסד/נושא בן 8 ספרות
2. THE MASAV_System SHALL לאפשר הזנת מספר מוסד שולח בן 5 ספרות
3. THE MASAV_System SHALL לאפשר הזנת שם המוסד עד 30 תווים
4. THE MASAV_System SHALL לשמור את ההגדרות במסד הנתונים
5. THE MASAV_System SHALL להציג את ההגדרות הנוכחיות בדף ההגדרות

### דרישה 2: ניהול פרטי בנק ללווים

**User Story:** כמנהל גמ"ח, אני רוצה לשמור פרטי בנק לכל לווה, כדי שאוכל לגבות ממנו תשלומים באמצעות מס"ב.

#### קריטריוני קבלה

1. THE MASAV_System SHALL לאפשר הזנת קוד בנק בן 2 ספרות ללווה
2. THE MASAV_System SHALL לאפשר הזנת מספר סניף בן 3 ספרות ללווה
3. THE MASAV_System SHALL לאפשר הזנת מספר חשבון בן 9 ספרות ללווה
4. THE MASAV_System SHALL לוודא שכל השדות מכילים ספרות בלבד
5. THE MASAV_System SHALL לשמור את פרטי הבנק במבנה הלווה
6. THE MASAV_System SHALL להציג את פרטי הבנק בדף עריכת לווה
7. THE MASAV_System SHALL לסמן לווים שחסרים להם פרטי בנק

### דרישה 3: בחירת לווים לגביה

**User Story:** כמנהל גמ"ח, אני רוצה לבחור אילו לווים לכלול בקובץ הגביה, כדי לגבות רק מהלווים הרלוונטיים.

#### קריטריוני קבלה

1. THE MASAV_System SHALL להציג רשימת לווים עם הלוואות פעילות
2. THE MASAV_System SHALL להציג רק לווים שיש להם פרטי בנק מלאים
3. THE MASAV_System SHALL לאפשר בחירה מרובה של לווים
4. THE MASAV_System SHALL להציג לכל לווה את סכום היתרה הכולל
5. THE MASAV_System SHALL לאפשר סינון לווים לפי קריטריונים
6. THE MASAV_System SHALL להציג אזהרה ללווים ברשימה שחורה

### דרישה 4: הגדרת סכומי חיוב

**User Story:** כמנהל גמ"ח, אני רוצה להגדיר את סכום החיוב לכל לווה, כדי לגבות את הסכום המדויק הנדרש.

#### קריטריוני קבלה

1. THE MASAV_System SHALL להציע אוטומטית את יתרת ההלוואה כסכום חיוב
2. THE MASAV_System SHALL לאפשר עריכה ידנית של סכום החיוב
3. THE MASAV_System SHALL לוודא שסכום החיוב גדול מאפס
4. THE MASAV_System SHALL לוודא שסכום החיוב לא עולה על יתרת ההלוואה
5. THE MASAV_System SHALL להציג את סכום החיוב בפורמט מטבע
6. THE MASAV_System SHALL לחשב את סך כל הסכומים לגביה

### דרישה 5: הגדרת תאריך חיוב

**User Story:** כמנהל גמ"ח, אני רוצה להגדיר את תאריך החיוב, כדי שהגביה תתבצע במועד הרצוי.

#### קריטריוני קבלה

1. THE MASAV_System SHALL לאפשר בחירת תאריך חיוב
2. THE MASAV_System SHALL להציע את התאריך הנוכחי כברירת מחדל
3. THE MASAV_System SHALL לוודא שתאריך החיוב לא בעבר
4. THE MASAV_System SHALL להציג את תאריך החיוב בפורמט ברור
5. THE MASAV_System SHALL לשמור את תאריך החיוב לכל הלווים שנבחרו

### דרישה 6: יצירת קובץ מס"ב

**User Story:** כמנהל גמ"ח, אני רוצה ליצור קובץ מס"ב בפורמט הנכון, כדי שאוכל להעלות אותו למערכת מס"ב ולבצע את הגביה.

#### קריטריוני קבלה

1. THE MASAV_System SHALL ליצור רשומת כותרת בפורמט מס"ב
2. THE MASAV_System SHALL ליצור רשומת תנועה לכל לווה שנבחר
3. THE MASAV_System SHALL ליצור רשומת סיכום עם סך הסכומים ומספר התנועות
4. THE MASAV_System SHALL להוסיף רשומת סיום (128 תשיעיות)
5. THE MASAV_System SHALL להוסיף CR+LF בסוף כל רשומה
6. THE MASAV_System SHALL לוודא שכל רשומה באורך 128 תווים בדיוק
7. THE MASAV_System SHALL למלא שדות נומריים באפסים מובילים
8. THE MASAV_System SHALL למלא שדות טקסט ברווחים מימין

### דרישה 7: פורמט רשומת כותרת

**User Story:** כמנהל גמ"ח, אני רוצה שרשומת הכותרת תכיל את כל הפרטים הנדרשים, כדי שמס"ב יזהה את המוסד והקובץ.

#### קריטריוני קבלה

1. THE Header_Record SHALL להתחיל בתו 'K' בפוזיציה 1
2. THE Header_Record SHALL לכלול את קוד המוסד בפוזיציות 2-9
3. THE Header_Record SHALL לכלול '00' כמטבע בפוזיציות 10-11
4. THE Header_Record SHALL לכלול את תאריך החיוב בפורמט YYMMDD בפוזיציות 12-17
5. THE Header_Record SHALL לכלול '001' כמספר סידורי בפוזיציות 19-21
6. THE Header_Record SHALL לכלול את תאריך יצירת הקובץ בפורמט YYMMDD בפוזיציות 23-28
7. THE Header_Record SHALL לכלול את מספר המוסד השולח בפוזיציות 29-33
8. THE Header_Record SHALL לכלול את שם המוסד בפוזיציות 40-69
9. THE Header_Record SHALL לכלול 'KOT' בפוזיציות 126-128

### דרישה 8: פורמט רשומת תנועה

**User Story:** כמנהל גמ"ח, אני רוצה שכל רשומת תנועה תכיל את פרטי החיוב המלאים, כדי שהחיוב יבוצע נכון.

#### קריטריוני קבלה

1. THE Transaction_Record SHALL להתחיל בתו '1' בפוזיציה 1
2. THE Transaction_Record SHALL לכלול את קוד המוסד בפוזיציות 2-9
3. THE Transaction_Record SHALL לכלול את קוד הבנק בפוזיציות 18-19
4. THE Transaction_Record SHALL לכלול את מספר הסניף בפוזיציות 20-22
5. THE Transaction_Record SHALL לכלול '0000' כסוג חשבון בפוזיציות 23-26
6. THE Transaction_Record SHALL לכלול את מספר החשבון בפוזיציות 27-35
7. THE Transaction_Record SHALL לכלול את מספר הזהות בפוזיציות 37-45
8. THE Transaction_Record SHALL לכלול את שם הלווה בפוזיציות 46-61
9. THE Transaction_Record SHALL לכלול את סכום החיוב בפוזיציות 62-74 (11 ש"ח + 2 אגורות)
10. THE Transaction_Record SHALL לכלול מספר אסמכתא ייחודי בפוזיציות 75-94
11. THE Transaction_Record SHALL לכלול '504' כסוג תנועה בפוזיציות 106-108

### דרישה 9: פורמט רשומת סיכום

**User Story:** כמנהל גמ"ח, אני רוצה שרשומת הסיכום תכיל נתוני בקרה נכונים, כדי שמס"ב יוכל לאמת את הקובץ.

#### קריטריוני קבלה

1. THE Summary_Record SHALL להתחיל בתו '5' בפוזיציה 1
2. THE Summary_Record SHALL לכלול את קוד המוסד בפוזיציות 2-9
3. THE Summary_Record SHALL לכלול את תאריך החיוב בפוזיציות 12-17
4. THE Summary_Record SHALL לכלול את מספר סידורי הקובץ בפוזיציות 19-21
5. THE Summary_Record SHALL לכלול את סכום כל התנועות בפוזיציות 37-51
6. THE Summary_Record SHALL לכלול את מספר התנועות בפוזיציות 59-65
7. THE Summary_Record SHALL לוודא שסכום התנועות תואם לסכום ברשומות התנועה

### דרישה 10: הורדת קובץ מס"ב

**User Story:** כמנהל גמ"ח, אני רוצה להוריד את קובץ מס"ב למחשב, כדי שאוכל להעלות אותו למערכת מס"ב.

#### קריטריוני קבלה

1. THE MASAV_System SHALL ליצור קובץ טקסט בקידוד ASCII
2. THE MASAV_System SHALL לשמור את הקובץ עם שם תיאורי הכולל תאריך
3. THE MASAV_System SHALL להוריד את הקובץ למחשב המשתמש
4. THE MASAV_System SHALL להציג הודעת הצלחה לאחר יצירת הקובץ
5. THE MASAV_System SHALL לשמור רשומה של קבצים שנוצרו

### דרישה 11: ניהול מספרי אסמכתא

**User Story:** כמנהל גמ"ח, אני רוצה שהמערכת תנהל אוטומטית מספרי אסמכתא ייחודיים, כדי שלא יהיו כפילויות.

#### קריטריוני קבלה

1. THE MASAV_System SHALL ליצור מספר אסמכתא ייחודי לכל חיוב
2. THE MASAV_System SHALL לוודא שמספר האסמכתא בן 6 ספרות ימניות
3. THE MASAV_System SHALL לשמור את מספר האסמכתא האחרון שנוצר
4. THE MASAV_System SHALL להגדיל את מספר האסמכתא בכל חיוב חדש
5. THE MASAV_System SHALL לאפשר איפוס מונה האסמכתאות
6. THE MASAV_System SHALL לקשר כל אסמכתא להלוואה ולתאריך החיוב

### דרישה 12: תצוגת מידע ואישור

**User Story:** כמנהל גמ"ח, אני רוצה לראות סיכום מפורט לפני יצירת הקובץ, כדי לוודא שהכל נכון.

#### קריטריוני קבלה

1. THE MASAV_System SHALL להציג סיכום של כל הלווים שנבחרו
2. THE MASAV_System SHALL להציג את סך כל הסכומים לגביה
3. THE MASAV_System SHALL להציג את מספר החיובים
4. THE MASAV_System SHALL להציג את תאריך החיוב
5. THE MASAV_System SHALL לדרוש אישור סופי לפני יצירת הקובץ
6. THE MASAV_System SHALL לאפשר חזרה לעריכה

### דרישה 13: טיפול בשגיאות

**User Story:** כמנהל גמ"ח, אני רוצה לקבל הודעות ברורות על שגיאות, כדי לתקן אותן לפני יצירת הקובץ.

#### קריטריוני קבלה

1. THE MASAV_System SHALL לוודא שהוגדרו פרטי מוסד לפני יצירת קובץ
2. THE MASAV_System SHALL לוודא שנבחר לפחות לווה אחד
3. THE MASAV_System SHALL לוודא שלכל לווה יש פרטי בנק מלאים
4. THE MASAV_System SHALL לוודא שכל הסכומים תקינים
5. THE MASAV_System SHALL להציג הודעת שגיאה ברורה לכל בעיה
6. THE MASAV_System SHALL למנוע יצירת קובץ לא תקין

### דרישה 14: היסטוריית קבצים

**User Story:** כמנהל גמ"ח, אני רוצה לראות היסטוריה של קבצים שיצרתי, כדי לעקוב אחר הגבייה ולמנוע כפילויות.

#### קריטריוני קבלה

1. THE MASAV_System SHALL לשמור רשומה של כל קובץ שנוצר
2. THE MASAV_System SHALL לשמור את תאריך יצירת הקובץ
3. THE MASAV_System SHALL לשמור את רשימת הלווים שנכללו בקובץ
4. THE MASAV_System SHALL לשמור את סך הסכומים בקובץ
5. THE MASAV_System SHALL להציג היסטוריה של קבצים שנוצרו
6. THE MASAV_System SHALL לאפשר הורדה מחדש של קובץ קיים
