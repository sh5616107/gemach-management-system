# תוכנית מימוש - מערכת יצירת קבצי מס"ב

## סקירה

תוכנית זו מפרטת את השלבים הנדרשים למימוש מערכת יצירת קבצי מס"ב לגביית תשלומים באמצעות הרשאה לחיוב חשבון. כל משימה בנויה על הקודמות ומסתיימת בקוד מתפקד ומשולב.

## משימות

- [x] 1. הוספת מבני נתונים ומתודות Database


- [x] 1.1 הרחבת interface DatabaseBorrower עם פרטי בנק


  - הוסף שדות: bankCode (2 ספרות), branchNumber (3 ספרות), accountNumber (9 ספרות)
  - כל השדות אופציונליים (?)
  - _דרישות: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 1.2 יצירת interface MasavSettings


  - שדות: institutionCode (8 ספרות), senderCode (5 ספרות), institutionName (30 תווים)
  - שדה: lastReferenceNumber (מספר אסמכתא אחרון)
  - הוסף ל-DatabaseFile
  - _דרישות: 1.1, 1.2, 1.3, 1.4, 1.5_


- [x] 1.3 יצירת interface MasavCharge


  - שדות: borrowerId, borrowerName, idNumber, bankCode, branchNumber, accountNumber
  - שדות: amount, referenceNumber, chargeDate, loanId
  - _דרישות: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_




- [ ] 1.4 יצירת interface MasavFileRecord
  - שדות: id, creationDate, chargeDate, totalAmount, chargesCount
  - שדות: charges (array), fileName, fileContent, status
  - status: 'pending' | 'confirmed' | 'cancelled'
  - הוסף masavFiles ל-DatabaseFile



  - _דרישות: 14.1, 14.2, 14.3, 14.4, 14.5, 14.6_

- [ ] 1.5 הוספת מתודות בסיסיות ל-GemachDatabase

  - getMasavSettings() - קבלת הגדרות מס"ב


  - updateMasavSettings() - עדכון הגדרות


  - getMasavFiles() - קבלת כל קבצי מס"ב
  - addMasavFile() - הוספת קובץ חדש
  - updateMasavFileStatus() - עדכון סטטוס קובץ


  - getNextReferenceNumber() - קבלת מספר אסמכתא הבא
  - _דרישות: 1.1, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_

- [x] 2. יצירת utility לבניית קובץ מס"ב



- [ ] 2.1 צור קובץ masavFileBuilder.ts
  - מיקום: src/utils/masavFileBuilder.ts
  - פונקציות עזר: padLeft, padRight, formatAmount, formatDate, reverseHebrew
  - _דרישות: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8_



- [ ] 2.2 מימוש buildHeaderRecord
  - קבלת פרמטרים: institutionCode, chargeDate, creationDate, senderCode, institutionName
  - בניית רשומת כותרת 128 תווים
  - הוספת CR+LF


  - _דרישות: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9_

- [x] 2.3 מימוש buildTransactionRecord


  - קבלת פרמטרים: institutionCode, charge
  - בניית רשומת תנועה 128 תווים
  - היפוך שם עברי (reverseHebrew)



  - המרת סכום לאגורות (*100)


  - הוספת CR+LF
  - _דרישות: 8.1-8.11_




- [x] 2.4 מימוש buildSummaryRecord


  - קבלת פרמטרים: institutionCode, chargeDate, totalAmount, transactionsCount
  - בניית רשומת סיכום 128 תווים
  - הוספת CR+LF
  - _דרישות: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_



- [ ] 2.5 מימוש buildEndRecord
  - יצירת 128 תשיעיות
  - הוספת CR+LF
  - _דרישות: 6.4_

- [ ] 2.6 מימוש buildMasavFile
  - קבלת: settings, charges, chargeDate
  - בניית קובץ מלא: כותרת + תנועות + סיכום + סיום
  - החזרת string מוכן להורדה
  - _דרישות: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3. הוספת הגדרות מס"ב לדף Settings


- [x] 3.1 עדכן SettingsPage.tsx

  - הוסף סקציה "הגדרות מס"ב"
  - שדות: קוד מוסד (8), מוסד שולח (5), שם מוסד (30)
  - ולידציה: אורך נכון, ספרות בלבד (למספרים)
  - שמירה אוטומטית
  - _דרישות: 1.1, 1.2, 1.3, 1.4, 1.5_


- [x] 4. הוספת פרטי בנק לדף עריכת לווה


- [ ] 4.1 עדכן את טופס עריכת לווה ב-LoansPage
  - הוסף סקציה "פרטי בנק (למס"ב)"
  - שדות: קוד בנק (2), מספר סניף (3), מספר חשבון (9)
  - אינטגרציה עם BankBranchSelector הקיים
  - ולידציה: ספרות בלבד, אורך נכון
  - סימון ויזואלי אם פרטי בנק חסרים
  - _דרישות: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [x] 5. יצירת דף יצירת קובץ מס"ב - שלב 1


- [x] 5.1 צור קובץ MasavFileGeneratorPage.tsx


  - מיקום: src/pages/MasavFileGeneratorPage.tsx
  - מבנה בסיסי עם header ו-stepper (4 שלבים)
  - state management לשלבים
  - _דרישות: 12.1, 12.2_


- [x] 5.2 מימוש שלב 1 - בחירת לווים

  - טעינת לווים עם הלוואות פעילות
  - סינון: רק לווים עם פרטי בנק מלאים
  - checkbox לכל לווה
  - הצגת: שם, ת.ז, פרטי בנק, יתרה
  - חיפוש וסינון
  - checkbox "בחר הכל"
  - סיכום: מספר נבחרים וסכום כולל
  - _דרישות: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 6. יצירת דף יצירת קובץ מס"ב - שלב 2



- [x] 6.1 מימוש שלב 2 - הגדרת סכומים


  - הצגת כל לווה שנבחר
  - שדה סכום לכל לווה
  - ברירת מחדל: סכום תשלום קרוב (או יתרה)
  - כפתור "מלא" למילוי יתרה מלאה
  - ולידציה: סכום > 0, לא עולה על יתרה
  - סיכום: סה"כ לגביה
  - _דרישות: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 7. יצירת דף יצירת קובץ מס"ב - שלב 3



- [x] 7.1 מימוש שלב 3 - תאריך חיוב


  - date picker לבחירת תאריך
  - ברירת מחדל: תאריך נוכחי
  - ולידציה: לא בעבר
  - הסבר על תאריך החיוב
  - _דרישות: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8. יצירת דף יצירת קובץ מס"ב - שלב 4



- [x] 8.1 מימוש שלב 4 - סיכום ואישור


  - הצגת סיכום: מספר חיובים, סכום כולל, תאריך
  - רשימת לווים והסכומים
  - שם קובץ: Msv[dd-mm-yy].001
  - אזהרה: "הקובץ יישמר בהיסטוריה"

  - כפתור "צור קובץ"
  - _דרישות: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_


- [x] 9. יצירת והורדת קובץ מס"ב








- [ ] 9.1 מימוש יצירת הקובץ
  - בדיקת הגדרות מוסד
  - יצירת מספרי אסמכתא


  - קריאה ל-buildMasavFile



  - שמירת הקובץ ב-masavFiles (סטטוס: pending)


  - _דרישות: 6.1, 6.2, 6.3, 13.1, 13.2, 13.3_

- [ ] 9.2 מימוש הורדת הקובץ
  - יצירת Blob עם תוכן הקובץ




  - קידוד ASCII
  - שם קובץ: Msv[dd-mm-yy].001
  - הורדה למחשב המשתמש




  - _דרישות: 10.1, 10.2, 10.3, 10.4_





- [x] 9.3 הצגת הודעת הצלחה


  - מודל עם הודעת הצלחה
  - פרטי הקובץ


  - כפתורים: "פתח תיקייה", "צור קובץ נוסף", "סגור"
  - _דרישות: 10.4, 12.5_

- [ ] 10. דף היסטוריית קבצי מס"ב



- [ ] 10.1 צור קובץ MasavHistoryPage.tsx
  - מיקום: src/pages/MasavHistoryPage.tsx
  - טעינת כל קבצי מס"ב
  - הצגת: תאריך, מספר חיובים, סכום, סטטוס


  - _דרישות: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 10.2 מימוש אישור גביה


  - כפתור "אשר גביה" לקבצים ב-pending
  - מודל אישור
  - רישום אוטומטי של תשלומים לכל החיובים


  - עדכון סטטוס ל-confirmed


  - _דרישות: 14.5_

- [ ] 10.3 מימוש ביטול קובץ
  - כפתור "בטל" לקבצים ב-pending
  - מודל אישור


  - עדכון סטטוס ל-cancelled
  - _דרישות: 14.5_

- [x] 10.4 מימוש הורדה מחדש


  - כפתור "הורד מחדש" לכל קובץ


  - שימוש ב-fileContent השמור
  - _דרישות: 14.6_

- [ ] 10.5 מימוש צפייה בפרטים
  - לחיצה על קובץ פותחת מודל
  - הצגת כל החיובים בקובץ
  - פרטי כל לווה וסכום
  - _דרישות: 14.5_

- [x] 11. אינטגרציה ב-AdminToolsPage



- [x] 11.1 הוסף כרטיס "קבצי מס"ב"


  - עיצוב בכחול (#3b82f6)
  - אייקון 🏦
  - תיאור: "יצירת קבצים לגביית תשלומים"
  - ניווט ל-MasavFileGeneratorPage
  - _דרישות: 12.1_

- [x] 11.2 הוסף כרטיס "היסטוריית מס"ב"


  - עיצוב בכחול בהיר
  - אייקון 📋
  - תיאור: "צפייה בקבצים שנוצרו ואישור גבייה"
  - ניווט ל-MasavHistoryPage
  - _דרישות: 14.1_

- [x] 12. הוספת routes ב-App.tsx



- [x] 12.1 הוסף routes


  - /masav-generator → MasavFileGeneratorPage
  - /masav-history → MasavHistoryPage
  - _דרישות: 12.1, 14.1_

- [x] 13. בדיקות ותיקונים



- [x] 13.1 בדוק תהליך מלא


  - הגדרת מוסד
  - הוספת פרטי בנק ללווה
  - יצירת קובץ עם לווה אחד
  - בדיקת תוכן הקובץ (128 תווים, CR+LF)
  - אישור גביה
  - בדיקת רישום תשלום
  - _דרישות: כל הדרישות_

- [x] 13.2 בדוק תהליך עם מספר לווים


  - יצירת קובץ עם 3 לווים
  - בדיקת סכומים
  - בדיקת רשומת סיכום
  - _דרישות: כל הדרישות_

- [x] 13.3 בדוק ולידציות


  - לווה ללא פרטי בנק
  - הגדרות מוסד חסרות
  - סכום לא תקין
  - תאריך בעבר
  - _דרישות: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6_

- [x] 13.4 בדוק היסטוריה


  - צפייה בקבצים
  - אישור גביה
  - ביטול קובץ
  - הורדה מחדש
  - _דרישות: 14.1-14.6_

- [x] 13.5 תקן באגים ובעיות UI


  - בדוק responsive design
  - בדוק עברית RTL
  - תקן שגיאות קונסול
  - שפר הודעות למשתמש
  - _דרישות: כל הדרישות_

- [x] 14. תיעוד




- [x] 14.1 הוסף הערות קוד


  - JSDoc לפונקציות ב-masavFileBuilder
  - הערות על פורמט מס"ב
  - דוגמאות שימוש
  - _דרישות: כל הדרישות_

- [x] 14.2 צור מדריך משתמש


  - הסבר על מס"ב והרשאה לחיוב חשבון
  - הדרכה על הגדרת המוסד
  - הדרכה על הוספת פרטי בנק
  - הדרכה על יצירת קובץ
  - הדרכה על אישור גביה
  - שאלות נפוצות
  - _דרישות: כל הדרישות_
