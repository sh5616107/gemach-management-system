generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// לווים
model Borrower {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  city        String
  phone       String
  phone2      String?
  address     String
  email       String
  idNumber    String   @unique
  notes       String?
  
  // פרטי בנק למסב
  bankCode      String?
  branchNumber  String?
  accountNumber String?
  
  loans       Loan[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([idNumber])
  @@index([firstName, lastName])
}

// ערבים
model Guarantor {
  id              Int      @id @default(autoincrement())
  firstName       String
  lastName        String
  idNumber        String   @unique
  phone           String
  email           String?
  address         String?
  notes           String?
  
  status          String   @default("active") // 'active' | 'blacklisted' | 'at_risk'
  blacklistReason String?
  blacklistDate   DateTime?
  blacklistBy     String?
  
  // פרטי בנק
  bankCode        String?
  branchNumber    String?
  accountNumber   String?
  
  loansAsGuarantor1 Loan[] @relation("Guarantor1")
  loansAsGuarantor2 Loan[] @relation("Guarantor2")
  debts             GuarantorDebt[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([idNumber])
  @@index([status])
}

// הלוואות
model Loan {
  id                    Int      @id @default(autoincrement())
  borrowerId            Int
  borrower              Borrower @relation(fields: [borrowerId], references: [id])
  
  amount                Float
  loanDate              DateTime
  returnDate            DateTime
  createdDate           DateTime @default(now())
  loanType              String   // 'fixed' | 'flexible'
  
  // ערבים
  guarantor1Id          Int?
  guarantor2Id          Int?
  guarantor1            Guarantor? @relation("Guarantor1", fields: [guarantor1Id], references: [id])
  guarantor2            Guarantor? @relation("Guarantor2", fields: [guarantor2Id], references: [id])
  
  // הלוואות מחזוריות
  isRecurring           Boolean  @default(false)
  recurringDay          Int?
  recurringMonths       Int?
  
  // פרעון אוטומטי
  autoPayment           Boolean  @default(false)
  autoPaymentAmount     Float?
  autoPaymentDay        Int?
  autoPaymentStartDate  DateTime?
  autoPaymentFrequency  Int?
  
  // אמצעי תשלום
  loanPaymentMethod     String?
  loanPaymentDetails    Json?
  paymentDetailsComplete Boolean @default(false)
  
  notes                 String?
  status                String   @default("active") // 'active' | 'completed' | 'overdue'
  reminderSent          DateTime?
  
  // העברה לערבים
  transferredToGuarantors Boolean @default(false)
  transferDate            DateTime?
  transferredBy           String?
  transferNotes           String?
  
  payments              Payment[]
  
  @@index([borrowerId])
  @@index([status])
  @@index([returnDate])
}

// תשלומים
model Payment {
  id                      Int      @id @default(autoincrement())
  loanId                  Int
  loan                    Loan     @relation(fields: [loanId], references: [id])
  
  amount                  Float
  date                    DateTime
  type                    String   // 'loan' | 'payment'
  
  paymentMethod           String?
  paymentDetails          Json?
  paymentDetailsComplete  Boolean  @default(false)
  
  notes                   String?
  
  // תשלום ערב
  paidBy                  String?  // 'borrower' | 'guarantor'
  guarantorId             Int?
  guarantorName           String?
  
  @@index([loanId])
  @@index([date])
}

// מפקידים
model Depositor {
  id              Int      @id @default(autoincrement())
  name            String
  idNumber        String?
  phone           String
  notes           String?
  
  // פרטי בנק
  bankCode        String?
  branchNumber    String?
  accountNumber   String?
  
  deposits        Deposit[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([idNumber])
}

// פיקדונות
model Deposit {
  id                      Int      @id @default(autoincrement())
  depositorId             Int
  depositor               Depositor @relation(fields: [depositorId], references: [id])
  
  amount                  Float
  depositDate             DateTime
  depositPeriod           Int
  reminderDays            Int?
  
  notes                   String?
  status                  String   @default("active") // 'active' | 'withdrawn'
  
  // אמצעי תשלום
  depositPaymentMethod    String?
  depositPaymentDetails   Json?
  
  // הפקדות מחזוריות
  isRecurring             Boolean  @default(false)
  recurringDay            Int?
  recurringMonths         Int?
  recurringEndDate        DateTime?
  lastRecurringDate       DateTime?
  
  withdrawals             Withdrawal[]
  
  @@index([depositorId])
  @@index([status])
  @@index([depositDate])
}

// משיכות
model Withdrawal {
  id                      Int      @id @default(autoincrement())
  depositId               Int
  deposit                 Deposit  @relation(fields: [depositId], references: [id])
  
  amount                  Float
  date                    DateTime
  
  paymentMethod           String?
  paymentDetails          Json?
  paymentDetailsComplete  Boolean  @default(false)
  
  notes                   String?
  
  @@index([depositId])
  @@index([date])
}

// תרומות
model Donation {
  id              Int      @id @default(autoincrement())
  donorName       String
  donorLastName   String
  amount          Float
  donationDate    DateTime
  method          String
  paymentDetails  Json?
  phone           String
  address         String
  notes           String?
  needsReceipt    Boolean  @default(false)
  
  @@index([donationDate])
}

// חובות ערבים
model GuarantorDebt {
  id                  Int      @id @default(autoincrement())
  originalLoanId      Int
  guarantorId         Int
  guarantor           Guarantor @relation(fields: [guarantorId], references: [id])
  originalBorrowerId  Int
  
  amount              Float
  transferDate        DateTime
  transferredBy       String
  
  paymentType         String   // 'single' | 'installments'
  installmentsCount   Int?
  installmentAmount   Float?
  installmentDates    Json?
  
  status              String   @default("active") // 'active' | 'paid' | 'overdue'
  notes               String?
  
  @@index([guarantorId])
  @@index([status])
}

// הוצאות
model Expense {
  id              Int      @id @default(autoincrement())
  type            String   // 'bank_fee' | 'office' | 'salary' | 'other'
  amount          Float
  date            DateTime
  description     String
  
  paidBy          String   // 'gemach' | 'borrower' | 'donor'
  borrowerId      Int?
  borrowerName    String?
  donorName       String?
  loanId          Int?
  
  paymentMethod   String?
  receiptNumber   String?
  notes           String?
  
  @@index([date])
  @@index([type])
}

// משתמשים
model User {
  id              Int      @id @default(autoincrement())
  username        String   @unique
  password        String   // hashed
  fullName        String
  email           String?
  role            String   @default("user") // 'admin' | 'user' | 'viewer'
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLogin       DateTime?
  
  @@index([username])
  @@index([role])
}

// הגדרות
model Settings {
  id                      Int      @id @default(autoincrement())
  gemachName              String
  gemachLogo              String?
  
  currency                String   @default("ILS")
  currencySymbol          String   @default("₪")
  
  headerTitle             String
  footerText              String
  contactText             String
  
  enableRecurringLoans    Boolean  @default(true)
  enableRecurringPayments Boolean  @default(true)
  requireIdNumber         Boolean  @default(false)
  showHebrewDates         Boolean  @default(false)
  showDateWarnings        Boolean  @default(true)
  trackPaymentMethods     Boolean  @default(true)
  enableMasav             Boolean  @default(false)
  enableCommission        Boolean  @default(false)
  commissionType          String   @default("percentage")
  commissionValue         Float    @default(0)
  
  appPassword             String?
  passwordHint            String?
  
  updatedAt               DateTime @updatedAt
}
