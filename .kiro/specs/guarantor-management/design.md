# עיצוב מערכת ניהול ערבים

## סקירה כללית

מערכת ניהול הערבים תורחב את המערכת הקיימת בהוספת טאב חדש לניהול ערבים, שיפור מבנה הנתונים, ואינטגרציה עמוקה עם מערכת ההלוואות. המערכת תכלול רשימה שחורה, מכתבי התראה ודוחות מתקדמים.

## ארכיטקטורה

### מבנה כללי
```
src/
├── pages/
│   ├── GuarantorsPage.tsx          # דף ניהול ערבים ראשי
│   ├── GuarantorDetailsPage.tsx    # דף פרטי ערב ספציפי
│   └── WarningLettersPage.tsx      # דף מכתבי התראה
├── components/
│   ├── GuarantorForm.tsx           # טופס הוספה/עריכת ערב
│   ├── GuarantorSelector.tsx       # רכיב בחירת ערב להלוואה
│   ├── BlacklistManager.tsx        # ניהול רשימה שחורה
│   └── WarningLetterGenerator.tsx  # יצירת מכתבי התראה
└── database/
    └── database.ts                 # הרחבת מסד הנתונים
```

### זרימת נתונים
1. **ניהול ערבים** ← GuarantorsPage ← database.ts
2. **בחירת ערב בהלוואה** ← LoansPage ← GuarantorSelector ← database.ts
3. **רשימה שחורה** ← BlacklistManager ← database.ts
4. **מכתבי התראה** ← WarningLettersPage ← database.ts

## רכיבים וממשקים

### 1. מבנה נתונים חדש

#### DatabaseGuarantor
```typescript
interface DatabaseGuarantor {
  id: number
  firstName: string
  lastName: string
  idNumber: string              // מספר זהות (חובה אם מופעל בהגדרות)
  phone: string                 // טלפון (חובה)
  email?: string               // אימייל (אופציונלי)
  address?: string             // כתובת (אופציונלי)
  notes?: string               // הערות (אופציונלי)
  status: 'active' | 'blacklisted' | 'at_risk'
  blacklistReason?: string     // סיבת חסימה
  blacklistDate?: string       // תאריך חסימה
  blacklistBy?: string         // מי חסם
  createdDate: string          // תאריך יצירה
  lastUpdated: string          // תאריך עדכון אחרון
  activeGuarantees: number     // מספר ערבויות פעילות (מחושב)
  totalRisk: number           // סיכון כולל בש"ח (מחושב)
}
```

#### DatabaseBlacklistEntry
```typescript
interface DatabaseBlacklistEntry {
  id: number
  type: 'borrower' | 'guarantor'
  personId: number             // ID של הלווה או הערב
  reason: string               // סיבת החסימה
  blockedDate: string          // תאריך חסימה
  blockedBy: string           // מי חסם
  removedDate?: string        // תאריך הסרה (אם הוסר)
  removedBy?: string          // מי הסיר
  removalReason?: string      // סיבת הסרה
  isActive: boolean           // האם החסימה פעילה
}
```

#### DatabaseWarningLetter
```typescript
interface DatabaseWarningLetter {
  id: number
  loanId: number              // הלוואה שעליה המכתב
  type: 'borrower' | 'guarantor' | 'both'
  recipientType: 'borrower' | 'guarantor'
  recipientId: number         // ID של הנמען
  content: string             // תוכן המכתב
  sentDate: string           // תאריך שליחה
  sentBy: string             // מי שלח
  method: 'print' | 'email' | 'sms' | 'phone'
  notes?: string             // הערות נוספות
}
```

### 2. עדכון מבנה הלוואה קיים

```typescript
interface DatabaseLoan {
  // שדות קיימים...
  guarantor1Id?: number        // ID ערב ראשון (במקום guarantor1 string)
  guarantor2Id?: number        // ID ערב שני (במקום guarantor2 string)
  guarantor1?: string         // שמירה לתאימות לאחור
  guarantor2?: string         // שמירה לתאימות לאחור
}
```

## מודלים של נתונים

### 1. מודל ערב
- **זיהוי ייחודי**: ID אוטומטי + מספר זהות (אם מופעל)
- **פרטים אישיים**: שם, טלפון, כתובת, אימייל
- **סטטוס**: פעיל, חסום, בסיכון
- **מעקב**: תאריכי יצירה ועדכון
- **חישובים**: מספר ערבויות פעילות וסיכון כולל

### 2. מודל רשימה שחורה
- **גמישות**: תמיכה בלווים וערבים
- **מעקב מלא**: מי חסם, מתי ולמה
- **היסטוריה**: שמירת כל החסימות וההסרות
- **סטטוס**: פעיל/לא פעיל

### 3. מודל מכתבי התראה
- **סוגים**: ללווה, לערב, או משותף
- **תוכן דינמי**: יצירה אוטומטית לפי תבנית
- **מעקב**: תיעוד שליחה ושיטה
- **קישור**: חיבור להלוואה ספציפית

## טיפול בשגיאות

### 1. ולידציות
- **מספר זהות**: בדיקת תקינות וייחודיות
- **טלפון**: פורמט תקין
- **ערב בהלוואה**: וידוא שהערב קיים ולא חסום
- **מחיקת ערב**: וידוא שאין ערבויות פעילות

### 2. שגיאות מערכת
- **כשל בטעינת נתונים**: הודעת שגיאה ברורה
- **כשל בשמירה**: ניסיון חוזר ושמירת נתונים מקומית
- **חסימת ערב בשימוש**: הודעת אזהרה והצעת חלופות

### 3. אזהרות משתמש
- **ערב בסיכון גבוה**: התראה ויזואלית
- **ערב חסום**: מניעת בחירה עם הסבר
- **מחיקת ערב**: אישור כפול עם פירוט השלכות

## אסטרטגיית בדיקות

### 1. בדיקות יחידה
- **פונקציות CRUD**: הוספה, עריכה, מחיקה של ערבים
- **חישובי סיכון**: בדיקת נכונות חישוב ערבויות פעילות
- **ולידציות**: בדיקת כל כללי הולידציה
- **רשימה שחורה**: בדיקת חסימה והסרה

### 2. בדיקות אינטגרציה
- **אינטגרציה עם הלוואות**: בחירת ערב בהלוואה חדשה
- **עדכון אוטומטי**: עדכון מספר ערבויות בעת יצירת/סגירת הלוואה
- **מכתבי התראה**: יצירה ושמירה נכונה
- **מיגרציה**: המרת נתונים קיימים

### 3. בדיקות ממשק משתמש
- **ניווט**: מעבר בין דפים ותפריטים
- **טפסים**: מילוי ושמירה נכונה
- **חיפוש וסינון**: פונקציונליות חיפוש ערבים
- **הודעות**: הצגת הודעות שגיאה והצלחה

### 4. בדיקות ביצועים
- **טעינת רשימות**: זמן טעינה עם מאות ערבים
- **חיפוש**: מהירות חיפוש בבסיס נתונים גדול
- **דוחות**: זמן יצירת דוחות מורכבים
- **זיכרון**: ניהול זיכרון יעיל

## שיקולי ביצועים

### 1. אופטימיזציה
- **אינדקסים**: יצירת אינדקסים על שדות חיפוש (שם, טלפון, ת.ז)
- **קאשינג**: שמירת רשימת ערבים בזיכרון לגישה מהירה
- **טעינה עצלה**: טעינת פרטים מלאים רק בעת הצורך
- **דחיסה**: דחיסת נתונים היסטוריים ישנים

### 2. ניהול זיכרון
- **גבולות**: הגבלת מספר רשומות בטעינה אחת
- **ניקוי**: ניקוי אוטומטי של נתונים לא בשימוש
- **סטרימינג**: טעינת נתונים בחלקים לדוחות גדולים

### 3. חוויית משתמש
- **טעינה אסינכרונית**: הצגת מחוון טעינה
- **עדכון מיידי**: עדכון ממשק בזמן אמת
- **שמירה אוטומטית**: שמירת טיוטות אוטומטית

## אבטחה ופרטיות

### 1. הגנת מידע
- **הצפנה**: הצפנת מספרי זהות וטלפונים רגישים
- **גישה**: בקרת גישה לפונקציות רגישות (רשימה שחורה)
- **ביקורת**: תיעוד כל הפעולות הרגישות
- **גיבוי**: גיבוי אוטומטי של נתוני ערבים

### 2. ולידציה
- **קלט משתמש**: ניקוי וולידציה של כל קלט
- **הרשאות**: וידוא הרשאות לפני פעולות רגישות
- **מגבלות**: הגבלת מספר ניסיונות כושלים

### 3. תאימות
- **GDPR**: זכות למחיקה ועדכון נתונים אישיים
- **שקיפות**: הסבר ברור על שימוש בנתונים
- **הסכמה**: קבלת הסכמה לשמירת נתונים אישיים